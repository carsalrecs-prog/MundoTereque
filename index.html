<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestra Wiki de Amor ‚ù§Ô∏è</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries (Versi√≥n Compat para estabilidad) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    
    <!-- Markdown Renderer para respuestas de IA -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');
        body { font-family: 'Nunito', sans-serif; transition: background-color 0.5s ease; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
        }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .theme-transition { transition: all 0.5s ease; }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #e11d48;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos para la respuesta de IA */
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { color: #db2777; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.8em; }

        /* Toast Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        
        .game-gradient {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 50%, #a18cd1 100%);
        }
        
        .ai-message-box {
            background: rgba(255, 255, 255, 0.9);
            border-left: 4px solid #8b5cf6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            color: #4c1d95;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- FIREBASE SETUP (MODO COMPAT) ---
        const firebaseConfig = JSON.parse(__firebase_config);
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API Key inyectada por el entorno

        const { useState, useEffect } = React;

        // --- ICONOS ---
        const Heart = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
        );
        const Download = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );
        const Trash2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );
        const Edit2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
        );
        const Search = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
        );
        const User = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const Plus = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
        );
        const Cloud = ({ size = 24, className = "" }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M4.5 19a5.5 5.5 0 1 1 3-10.16"/><path d="M19.5 19a5.5 5.5 0 1 0-3-10.16"/><line x1="1" y1="19" x2="23" y2="19"/></svg>
        );
        const Sparkles = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
        );
        const Check = ({ size = 24, className = "" }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>
        );
        const Dice = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><circle cx="15" cy="15" r="2"></circle></svg>
        );
        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const Brain = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
        );
        const Clock = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        );

        // --- TOAST COMPONENT ---
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';

            return (
                <div className={`fixed bottom-4 right-4 ${bgClass} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-2 toast-enter z-50`}>
                    {type === 'success' ? <Check size={18} /> : type === 'error' ? <X size={18} /> : <AlertCircle size={18} />}
                    <span className="font-bold">{message}</span>
                </div>
            );
        };

        // --- MODAL DE CONFIRMACI√ìN ---
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">¬øEst√°s seguro?</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-bold transition-colors">Cancelar</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 font-bold shadow-lg transition-colors">S√≠, eliminar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // --- ESTADOS ---
            const [user, setUser] = useState(null);
            const [activeProfile, setActiveProfile] = useState('novia');
            const [viewMode, setViewMode] = useState('wiki');
            const [entries, setEntries] = useState([]);
            const [categories, setCategories] = useState(['B√°sica', 'Gustos', 'Dif√≠cil / Profunda', 'Familia', 'Historia', 'Curiosidad']);
            const [formData, setFormData] = useState({ category: '', question: '', answer: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            
            const [editingId, setEditingId] = useState(null);
            const [toast, setToast] = useState(null);
            const [deleteModal, setDeleteModal] = useState({ isOpen: false, id: null, type: null });

            // IA - Or√°culo
            const [aiQuery, setAiQuery] = useState('');
            const [aiResponse, setAiResponse] = useState('');
            const [isAiThinking, setIsAiThinking] = useState(false);

            // IA - Juego Activo (Generador)
            const [gameQuestion, setGameQuestion] = useState('');
            const [isGeneratingGame, setIsGeneratingGame] = useState(false);
            const [answerFlor, setAnswerFlor] = useState('');
            const [answerTereque, setAnswerTereque] = useState('');
            
            // Lista de Juegos Pendientes
            const [pendingGames, setPendingGames] = useState([]);
            
            // Estados de input temporal para juegos pendientes
            const [pendingAnswers, setPendingAnswers] = useState({}); // { [gameId_role]: text }

            const [gameAnalysis, setGameAnalysis] = useState('');
            const [isAnalyzingGame, setIsAnalyzingGame] = useState(false);

            // --- AUTENTICACI√ìN ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                        showToast("Error de autenticaci√≥n", 'error');
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
                return () => unsubscribe();
            }, []);

            // --- DATOS WIKI ---
            useEffect(() => {
                if (!user) return;
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_entries');
                const unsubscribe = collectionRef.onSnapshot((snapshot) => {
                    const loadedEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    setEntries(loadedEntries);
                    setIsLoading(false);
                }, (error) => setIsLoading(false));
                return () => unsubscribe();
            }, [user]);

            // --- JUEGOS PENDIENTES (LISTA) ---
            useEffect(() => {
                if (!user) return;
                const pendingRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('pending_games');
                // Escuchar todos los pendientes, ordenados por fecha descendente
                const unsubscribe = pendingRef.orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    const games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPendingGames(games);
                });
                return () => unsubscribe();
            }, [user]);

            // --- CATEGORIAS ---
            useEffect(() => {
                if (!user) return;
                const catRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_settings').doc('categories');
                const unsubscribe = catRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) { setCategories(docSnap.data().list || ['B√°sica']); }
                });
                return () => unsubscribe();
            }, [user]);

            // --- MANEJADORES ---

            const showToast = (message, type = 'success') => { setToast({ message, type }); };

            useEffect(() => {
                if (!formData.category && categories.length > 0) { setFormData(prev => ({...prev, category: categories[0]})); }
            }, [categories]);

            useEffect(() => {
                if(viewMode === 'game') {
                    document.body.style.backgroundColor = '#f3e8ff'; 
                } else {
                    document.body.style.backgroundColor = activeProfile === 'novia' ? '#fff1f2' : '#eff6ff';
                }
                setAiResponse(''); setAiQuery(''); setEditingId(null);
                setFormData(prev => ({ category: categories[0], question: '', answer: '' }));
                setGameAnalysis('');
            }, [activeProfile, viewMode]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.question || !formData.answer || !user) return;
                const entryData = { target: activeProfile, category: formData.category, question: formData.question, answer: formData.answer, date: new Date().toLocaleDateString(), timestamp: Date.now() };
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_entries');
                try {
                    if (editingId) {
                        await collectionRef.doc(editingId).update({ category: formData.category, question: formData.question, answer: formData.answer });
                        showToast("Recuerdo actualizado ‚ú®"); setEditingId(null);
                    } else {
                        await collectionRef.add(entryData);
                        showToast("Recuerdo guardado ‚ù§Ô∏è");
                    }
                    setFormData(prev => ({ ...prev, question: '', answer: '' }));
                } catch (error) { showToast("Error al guardar", 'error'); }
            };

            const handleEdit = (entry) => {
                setEditingId(entry.id);
                setFormData({ category: entry.category, question: entry.question, answer: entry.answer });
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showToast("Editando recuerdo...", 'success');
            };

            const handleCancelEdit = () => { setEditingId(null); setFormData(prev => ({ ...prev, question: '', answer: '' })); };

            const handleDelete = (id) => { setDeleteModal({ isOpen: true, id, type: 'wiki' }); };

            const confirmDelete = async () => {
                const { id, type } = deleteModal;
                if (!id) return;
                if (type === 'wiki') {
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_entries').doc(id).delete();
                        showToast("Recuerdo eliminado üóëÔ∏è", 'success');
                        if (editingId === id) handleCancelEdit();
                    } catch (error) { showToast("No se pudo eliminar", 'error'); }
                } else if (type === 'game_skip') {
                     const pendingRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('pending_games');
                     await pendingRef.doc(id).delete();
                     showToast("Pregunta descartada");
                }
                setDeleteModal({ isOpen: false, id: null, type: null });
            };

            const handleAddCategory = async () => {
                if (newCategoryName.trim() && !categories.includes(newCategoryName)) {
                    const newCats = [...categories, newCategoryName];
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_settings').doc('categories').set({ list: newCats });
                        setFormData(prev => ({...prev, category: newCategoryName})); setNewCategoryName(''); setIsAddingCategory(false);
                        showToast(`Categor√≠a "${newCategoryName}" creada`);
                    } catch (error) { showToast("Error creando categor√≠a", 'error'); }
                }
            };

            const downloadCSV = () => {
                let csvContent = "\uFEFFDe Qui√©n;Categor√≠a;Pregunta;Respuesta;Fecha\n";
                const sortedEntries = [...entries].sort((a,b) => a.target === activeProfile ? -1 : 1);
                sortedEntries.forEach(row => {
                    const who = row.target === 'novia' ? 'Flor de Desierto' : 'Tereque';
                    const cleanQ = (row.question || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    const cleanA = (row.answer || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    csvContent += `"${who}";"${row.category}";"${cleanQ}";"${cleanA}";"${row.date}"\n`;
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `wiki_pareja_completa.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast("Excel descargado üì•");
            };

            const handleAskAI = async (e) => {
                e.preventDefault(); if (!aiQuery.trim()) return;
                setIsAiThinking(true); setAiResponse('');
                const relevantEntries = entries.filter(e => e.target === activeProfile);
                const contextText = relevantEntries.map(e => `- ${e.category}: P: ${e.question} R: ${e.answer}`).join("\n");
                const persona = activeProfile === 'novia' ? 'Flor de Desierto' : 'Tereque';
                const systemPrompt = `Eres un experto asistente de relaciones enfocado en ${persona}. Datos: ${contextText}. Responde breve y √∫til.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: aiQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                    });
                    const data = await response.json();
                    setAiResponse(data.candidates?.[0]?.content?.parts?.[0]?.text || "Error de IA.");
                } catch (error) { setAiResponse("Error de conexi√≥n."); } finally { setIsAiThinking(false); }
            };

            // --- GENERAR NUEVA PREGUNTA (JUEGO) ---
            const handleGenerateGameQuestion = async () => {
                setIsGeneratingGame(true); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque(''); setGameAnalysis('');
                const systemPrompt = `Genera una pregunta interesante para parejas. Solo la pregunta.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Dame una pregunta" }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                    });
                    const data = await response.json();
                    setGameQuestion(data.candidates?.[0]?.content?.parts?.[0]?.text || "Pregunta default");
                } catch (error) { setGameQuestion("¬øCu√°l es tu recuerdo favorito?"); } finally { setIsGeneratingGame(false); }
            };

            // --- GUARDAR JUEGO (ACTIVO) ---
            const handleSaveActiveGame = async () => {
                if (!gameQuestion) return;
                const hasFlor = answerFlor && answerFlor.trim().length > 0;
                const hasTereque = answerTereque && answerTereque.trim().length > 0;
                if (!hasFlor && !hasTereque) { showToast("Escribe al menos una respuesta", 'error'); return; }

                const wikiRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_entries');
                const pendingRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('pending_games');

                try {
                    if (hasFlor && hasTereque) {
                        // Ambos respondieron -> Wiki
                        await wikiRef.add({ target: 'novia', category: 'Juego AI üé≤', question: gameQuestion, answer: answerFlor, date: new Date().toLocaleDateString(), timestamp: Date.now() });
                        await wikiRef.add({ target: 'novio', category: 'Juego AI üé≤', question: gameQuestion, answer: answerTereque, date: new Date().toLocaleDateString(), timestamp: Date.now() + 1 });
                        showToast("¬°Juego completado! Guardado üéâ");
                        // Limpiamos el generador
                        setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                    } else {
                        // Solo uno -> Pendientes
                        await pendingRef.add({
                            question: gameQuestion,
                            answerFlor: answerFlor || '',
                            answerTereque: answerTereque || '',
                            timestamp: Date.now()
                        });
                        showToast(`Guardado en pendientes para ${!hasFlor ? "Flor" : "Tereque"} ‚è≥`, 'info');
                        // Limpiamos el generador para que puedan seguir jugando
                        setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                    }
                } catch (error) { showToast("Error guardando", 'error'); }
            };

            // --- GUARDAR JUEGO PENDIENTE (LISTA) ---
            const handleCompletePendingGame = async (game) => {
                // Recuperar respuestas nuevas de los inputs locales
                const newFlor = pendingAnswers[`${game.id}_flor`] || game.answerFlor;
                const newTereque = pendingAnswers[`${game.id}_tereque`] || game.answerTereque;

                const hasFlor = newFlor && newFlor.trim().length > 0;
                const hasTereque = newTereque && newTereque.trim().length > 0;

                if (!hasFlor && !hasTereque) return; // No deber√≠a pasar

                const wikiRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('wiki_entries');
                const pendingRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('pending_games');

                try {
                    if (hasFlor && hasTereque) {
                        // Completado -> Mover a Wiki
                        await wikiRef.add({ target: 'novia', category: 'Juego AI üé≤', question: game.question, answer: newFlor, date: new Date().toLocaleDateString(), timestamp: Date.now() });
                        await wikiRef.add({ target: 'novio', category: 'Juego AI üé≤', question: game.question, answer: newTereque, date: new Date().toLocaleDateString(), timestamp: Date.now() + 1 });
                        // Borrar de pendientes
                        await pendingRef.doc(game.id).delete();
                        showToast("¬°Turno completado! üéâ");
                    } else {
                        // A√∫n incompleto -> Actualizar pendiente
                        await pendingRef.doc(game.id).update({
                            answerFlor: newFlor,
                            answerTereque: newTereque
                        });
                        showToast("Actualizado en pendientes ‚è≥");
                    }
                    // Limpiar inputs temporales
                    setPendingAnswers(prev => { const n = {...prev}; delete n[`${game.id}_flor`]; delete n[`${game.id}_tereque`]; return n; });
                } catch (error) { showToast("Error completando", 'error'); }
            };

            const handlePendingInputChange = (gameId, role, value) => {
                setPendingAnswers(prev => ({ ...prev, [`${gameId}_${role}`]: value }));
            };

            const handleAnalyzeGame = async () => {
                setIsAnalyzingGame(true); setGameAnalysis('');
                const prompt = `Analiza pareja. Pregunta: "${gameQuestion}". Flor: "${answerFlor}". Tereque: "${answerTereque}". Breve y divertido.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setGameAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text || "Genial!");
                } catch(e) { setGameAnalysis("Error analizando."); } finally { setIsAnalyzingGame(false); }
            };

            const handleSkipPendingGame = (id) => {
                setDeleteModal({ isOpen: true, id, type: 'game_skip' });
            };

            const filteredEntries = entries.filter(entry => entry.target === activeProfile && (entry.question.toLowerCase().includes(searchTerm.toLowerCase()) || entry.answer.toLowerCase().includes(searchTerm.toLowerCase())));

            // --- TEMAS ---
             const theme = activeProfile === 'novia' ? {
                primary: 'bg-rose-500', primaryHover: 'hover:bg-rose-600', light: 'bg-rose-50', border: 'border-rose-100', text: 'text-rose-600', textDark: 'text-rose-800', ring: 'focus:ring-rose-400', iconBg: 'bg-rose-100', gradientAi: 'from-rose-500 to-orange-400'
            } : {
                primary: 'bg-blue-500', primaryHover: 'hover:bg-blue-600', light: 'bg-blue-50', border: 'border-blue-100', text: 'text-blue-600', textDark: 'text-blue-800', ring: 'focus:ring-blue-400', iconBg: 'bg-blue-100', gradientAi: 'from-blue-500 to-cyan-400'
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto theme-transition pb-20">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <ConfirmationModal isOpen={deleteModal.isOpen} onClose={() => setDeleteModal({ isOpen: false, id: null, type: null })} onConfirm={confirmDelete} message={deleteModal.type === 'game_skip' ? "¬øDescartar esta pregunta pendiente?" : "¬øEliminar recuerdo?"} />

                    <header className="mb-6 glass-panel p-2 rounded-3xl flex flex-wrap justify-between items-center gap-4 sticky top-2 z-50 shadow-lg">
                        <div className="flex gap-2 w-full md:w-auto p-1 bg-gray-100 rounded-2xl">
                            <button onClick={() => setViewMode('wiki')} className={`flex-1 px-4 py-2 rounded-xl font-bold transition-all flex items-center gap-2 justify-center ${viewMode === 'wiki' ? 'bg-white shadow text-gray-800' : 'text-gray-400 hover:text-gray-600'}`}><Search size={18} /> Wiki</button>
                            <button onClick={() => setViewMode('game')} className={`flex-1 px-4 py-2 rounded-xl font-bold transition-all flex items-center gap-2 justify-center ${viewMode === 'game' ? 'bg-purple-500 shadow text-white' : 'text-gray-400 hover:text-gray-600'} ${pendingGames.length > 0 ? 'pending-pulse border-2 border-purple-300' : ''}`}><Dice size={18} /> Juego {pendingGames.length > 0 && <span className="bg-red-500 h-5 w-5 flex items-center justify-center text-[10px] rounded-full absolute top-1 right-1">{pendingGames.length}</span>}</button>
                        </div>
                        {viewMode === 'wiki' && (
                            <>
                                <div className="flex bg-gray-100 p-1 rounded-2xl w-full md:w-auto overflow-hidden">
                                    <button onClick={() => setActiveProfile('novia')} className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl font-bold transition-all text-sm md:text-base ${activeProfile === 'novia' ? 'bg-white text-rose-600 shadow-md' : 'text-gray-400 hover:text-gray-600'}`}><Heart size={16} className={activeProfile === 'novia' ? 'fill-rose-500' : ''} /> Flor</button>
                                    <button onClick={() => setActiveProfile('novio')} className={`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-xl font-bold transition-all text-sm md:text-base ${activeProfile === 'novio' ? 'bg-white text-blue-600 shadow-md' : 'text-gray-400 hover:text-gray-600'}`}><User size={16} className={activeProfile === 'novio' ? 'fill-blue-500' : ''} /> Tereque</button>
                                </div>
                                <div className="hidden md:flex items-center gap-3"><div className="text-right"><p className="text-xs text-gray-400 flex items-center justify-end gap-1"><Cloud size={10} /> {filteredEntries.length}</p></div><button onClick={downloadCSV} className="bg-gray-800 text-white p-2 rounded-lg hover:bg-gray-900 transition-all"><Download size={16} /></button></div>
                            </>
                        )}
                    </header>

                    {viewMode === 'game' ? (
                        <div className="fade-in max-w-3xl mx-auto space-y-8">
                            {/* GENERADOR DE JUEGO */}
                            <div className="game-gradient p-8 rounded-3xl shadow-2xl text-center text-white relative overflow-hidden">
                                <div className="relative z-10">
                                    <h2 className="text-3xl font-extrabold mb-4 drop-shadow-md">‚ú® Generador de Preguntas ‚ú®</h2>
                                    {!gameQuestion ? (
                                        <button onClick={handleGenerateGameQuestion} disabled={isGeneratingGame} className="bg-white text-purple-600 px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:scale-105 transition-transform flex items-center gap-2 mx-auto">{isGeneratingGame ? <div className="spinner border-purple-600 h-6 w-6"></div> : <><Sparkles size={20} /> Nueva Pregunta</>}</button>
                                    ) : (
                                        <div className="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 animate-in zoom-in duration-300 text-left">
                                            <h3 className="text-2xl font-bold text-white leading-relaxed text-center mb-6">"{gameQuestion}"</h3>
                                            <div className="space-y-4">
                                                <div className="bg-white/90 p-4 rounded-xl text-gray-800"><p className="text-xs text-rose-500 font-bold mb-1">Flor de Desierto</p><textarea value={answerFlor} onChange={(e) => setAnswerFlor(e.target.value)} placeholder="Respuesta..." className="w-full bg-transparent border-none focus:ring-0 resize-none h-16 text-sm"></textarea></div>
                                                <div className="bg-white/90 p-4 rounded-xl text-gray-800"><p className="text-xs text-blue-500 font-bold mb-1">Tereque</p><textarea value={answerTereque} onChange={(e) => setAnswerTereque(e.target.value)} placeholder="Respuesta..." className="w-full bg-transparent border-none focus:ring-0 resize-none h-16 text-sm"></textarea></div>
                                                <div className="flex gap-2">
                                                    <button onClick={handleSaveActiveGame} className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow transition-all">{answerFlor && answerTereque ? 'Guardar en Wiki' : 'Guardar como Pendiente'}</button>
                                                    <button onClick={() => setGameQuestion('')} className="px-4 py-3 bg-white/20 hover:bg-white/30 text-white rounded-xl font-bold">Cancelar</button>
                                                </div>
                                                {answerFlor && answerTereque && !gameAnalysis && <button onClick={handleAnalyzeGame} disabled={isAnalyzingGame} className="w-full text-white underline text-sm">{isAnalyzingGame ? 'Analizando...' : 'Ver opini√≥n de IA'}</button>}
                                                {gameAnalysis && <div className="bg-purple-100 p-3 rounded-xl text-purple-800 text-sm mt-2">{gameAnalysis}</div>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* LISTA DE PENDIENTES */}
                            {pendingGames.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-purple-800 mb-4 flex items-center gap-2"><Clock size={24} /> Turnos Pendientes ({pendingGames.length})</h3>
                                    <div className="space-y-4">
                                        {pendingGames.map(game => (
                                            <div key={game.id} className="bg-white p-6 rounded-2xl shadow-md border-l-8 border-purple-300 relative">
                                                <button onClick={() => handleSkipPendingGame(game.id)} className="absolute top-4 right-4 text-gray-300 hover:text-red-400"><Trash2 size={16}/></button>
                                                <h4 className="font-bold text-gray-800 mb-4 pr-8">"{game.question}"</h4>
                                                
                                                <div className="space-y-3">
                                                    {/* FLOR INPUT/DISPLAY */}
                                                    <div className={`p-3 rounded-xl border ${game.answerFlor ? 'bg-rose-50 border-rose-100' : 'bg-white border-rose-200 border-dashed'}`}>
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="text-xs font-bold text-rose-500 flex items-center gap-1"><Heart size={12}/> Flor de Desierto</span>
                                                            {game.answerFlor && <Check size={14} className="text-green-500"/>}
                                                        </div>
                                                        {game.answerFlor ? (
                                                            <p className="text-sm text-gray-700 italic">"{game.answerFlor}"</p>
                                                        ) : (
                                                            <textarea 
                                                                value={pendingAnswers[`${game.id}_flor`] || ''} 
                                                                onChange={(e) => handlePendingInputChange(game.id, 'flor', e.target.value)}
                                                                placeholder="Escribe tu respuesta..."
                                                                className="w-full text-sm p-2 rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-rose-200 outline-none resize-none"
                                                            ></textarea>
                                                        )}
                                                    </div>

                                                    {/* TEREQUE INPUT/DISPLAY */}
                                                    <div className={`p-3 rounded-xl border ${game.answerTereque ? 'bg-blue-50 border-blue-100' : 'bg-white border-blue-200 border-dashed'}`}>
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="text-xs font-bold text-blue-500 flex items-center gap-1"><User size={12}/> Tereque</span>
                                                            {game.answerTereque && <Check size={14} className="text-green-500"/>}
                                                        </div>
                                                        {game.answerTereque ? (
                                                            <p className="text-sm text-gray-700 italic">"{game.answerTereque}"</p>
                                                        ) : (
                                                            <textarea 
                                                                value={pendingAnswers[`${game.id}_tereque`] || ''} 
                                                                onChange={(e) => handlePendingInputChange(game.id, 'tereque', e.target.value)}
                                                                placeholder="Escribe tu respuesta..."
                                                                className="w-full text-sm p-2 rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none resize-none"
                                                            ></textarea>
                                                        )}
                                                    </div>

                                                    {/* ACCI√ìN */}
                                                    {(!game.answerFlor || !game.answerTereque) && (
                                                        <button 
                                                            onClick={() => handleCompletePendingGame(game)}
                                                            className="w-full py-2 bg-purple-100 text-purple-700 font-bold rounded-lg hover:bg-purple-200 transition-colors text-sm mt-2"
                                                        >
                                                            {(pendingAnswers[`${game.id}_flor`] || pendingAnswers[`${game.id}_tereque`]) ? 'Enviar Respuesta' : 'Esperando...'}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        // WIKI VIEW
                        <div className="grid md:grid-cols-12 gap-6 fade-in">
                            <div className="md:col-span-4 lg:col-span-4 space-y-6">
                                <div className={`glass-panel p-6 rounded-3xl sticky top-28 border-t-4 ${activeProfile === 'novia' ? 'border-rose-400' : 'border-blue-400'}`}>
                                    <h2 className={`text-xl font-bold ${theme.textDark} mb-4 flex items-center gap-2`}>{editingId ? <Edit2 size={20} /> : <Plus size={20} />}{editingId ? 'Editar Recuerdo' : 'Nuevo Recuerdo'}</h2>
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        <div><div className="flex justify-between items-center mb-1"><label className="text-sm font-bold text-gray-500">Categor√≠a</label>{!isAddingCategory && <button type="button" onClick={() => setIsAddingCategory(true)} className={`text-xs font-bold ${theme.text} hover:underline`}>+ Nueva</button>}</div>{isAddingCategory ? (<div className="flex gap-2"><input type="text" autoFocus placeholder="Nombre..." value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} className={`flex-1 p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 ${theme.ring} ${theme.border}`} /><button type="button" onClick={handleAddCategory} className={`p-2 rounded-lg text-white ${theme.primary}`}><Plus size={16} /></button><button type="button" onClick={() => setIsAddingCategory(false)} className="p-2 text-gray-400"><X size={16} /></button></div>) : (<select name="category" value={formData.category} onChange={handleInputChange} className={`w-full p-3 border rounded-xl focus:outline-none focus:ring-2 bg-white ${theme.ring} ${theme.border}`}>{categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select>)}</div>
                                        <div><label className="block text-sm font-bold text-gray-500 mb-1">Pregunta</label><input type="text" name="question" value={formData.question} onChange={handleInputChange} placeholder={activeProfile === 'novia' ? "¬øFlor favorita?" : "¬øEquipo?"} className={`w-full p-3 border rounded-xl focus:outline-none focus:ring-2 ${theme.ring} ${theme.border}`} required /></div>
                                        <div><label className="block text-sm font-bold text-gray-500 mb-1">Respuesta</label><textarea name="answer" value={formData.answer} onChange={handleInputChange} placeholder="Detalles..." className={`w-full p-3 border rounded-xl focus:outline-none focus:ring-2 h-24 resize-none ${theme.ring} ${theme.border}`} required ></textarea></div>
                                        <div className="flex gap-2">{editingId && <button type="button" onClick={handleCancelEdit} className="px-4 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300 transition-all">Cancelar</button>}<button type="submit" disabled={!user} className={`flex-1 py-3 px-4 rounded-xl text-white font-bold transition-all shadow-lg hover:shadow-xl hover:-translate-y-1 ${user ? theme.primary : 'bg-gray-400 cursor-not-allowed'} ${user ? theme.primaryHover : ''}`}>{editingId ? 'Actualizar' : (user ? 'Guardar' : 'Conectando...')}</button></div>
                                    </form>
                                </div>
                            </div>
                            <div className="md:col-span-8 lg:col-span-8 space-y-6">
                                <div className={`relative rounded-3xl p-6 text-white shadow-xl bg-gradient-to-r ${theme.gradientAi} overflow-hidden`}>
                                    <div className="absolute top-0 right-0 p-4 opacity-20"><Sparkles size={100} /></div>
                                    <h2 className="text-xl font-bold mb-2 flex items-center gap-2"><Sparkles size={24} /> {activeProfile === 'novia' ? 'Or√°culo de Flor' : 'Or√°culo de Tereque'}</h2>
                                    <p className="text-white/80 text-sm mb-4">Pregunta lo que quieras sobre {activeProfile === 'novia' ? 'ella' : '√©l'}...</p>
                                    <form onSubmit={handleAskAI} className="relative z-10 flex gap-2"><input type="text" value={aiQuery} onChange={(e) => setAiQuery(e.target.value)} placeholder="Ej: ¬øQu√© le regalo?" className="w-full p-3 rounded-xl text-gray-800 focus:outline-none shadow-lg" /><button type="submit" disabled={isAiThinking} className="bg-white/20 hover:bg-white/30 text-white font-bold p-3 rounded-xl backdrop-blur-sm border border-white/30">{isAiThinking ? <div className="spinner h-5 w-5 border-white"></div> : 'Preguntar'}</button></form>
                                    {aiResponse && (<div className="mt-4 bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 animate-in fade-in slide-in-from-bottom-2"><div className="flex gap-3"><div className="mt-1"><Sparkles size={16} className="text-yellow-300" /></div><div className="text-sm leading-relaxed markdown-body text-white" dangerouslySetInnerHTML={{__html: marked.parse(aiResponse)}}></div></div></div>)}
                                </div>
                                <div className="relative group"><div className={`absolute -inset-0.5 bg-gradient-to-r ${theme.gradient} rounded-2xl opacity-20 group-hover:opacity-40 transition duration-200 blur`}></div><div className="relative flex items-center bg-white rounded-xl"><Search className="ml-4 text-gray-400" size={20} /><input type="text" placeholder={`Buscar palabra clave...`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-4 rounded-xl focus:outline-none text-gray-600 placeholder-gray-400" /></div></div>
                                <div className="grid gap-4">{isLoading ? (<div className="text-center py-20"><div className="spinner border-rose-500 mx-auto mb-4 h-10 w-10 border-4"></div><p className="text-gray-400">Cargando nube...</p></div>) : filteredEntries.length === 0 ? (<div className="text-center py-20 opacity-50"><div className={`mx-auto w-24 h-24 rounded-full flex items-center justify-center mb-4 ${theme.light}`}><Search size={40} className={theme.text} /></div><p className="text-xl font-bold text-gray-400">Sin datos a√∫n</p></div>) : (filteredEntries.map(entry => (<div key={entry.id} className={`bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition-all border border-gray-100 relative group fade-in ${editingId === entry.id ? 'ring-2 ring-rose-300' : ''}`}><span className={`text-xs font-bold px-3 py-1 rounded-full mb-3 inline-block ${theme.light} ${theme.textDark}`}>{entry.category}</span><h3 className="font-bold text-gray-800 text-lg mb-2 pr-20">{entry.question}</h3><p className="text-gray-600 leading-relaxed whitespace-pre-line">{entry.answer}</p><div className="mt-4 flex justify-between items-center pt-4 border-t border-gray-50"><span className="text-xs text-gray-400 flex items-center gap-1">üìÖ {entry.date}</span><div className="flex gap-1"><button onClick={() => handleEdit(entry)} className="text-gray-300 hover:text-blue-500 transition-colors p-2 rounded-full hover:bg-blue-50" title="Editar"><Edit2 size={16} /></button><button onClick={() => handleDelete(entry.id)} className="text-gray-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50" title="Eliminar"><Trash2 size={16} /></button></div></div></div>)))}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>