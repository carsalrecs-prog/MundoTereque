<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ec4899">
    <title>Nuestra Wiki de Amor ‚ù§Ô∏è</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');
        body { font-family: 'Nunito', sans-serif; transition: background-color 0.5s ease; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .theme-transition { transition: all 0.5s ease; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #e11d48; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { color: #db2777; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .game-gradient { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 50%, #a18cd1 100%); }
        .pending-pulse { animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); } }
        .ai-message-box { background: rgba(255, 255, 255, 0.9); border-left: 4px solid #8b5cf6; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; color: #4c1d95; }
        /* Help Modal Styles */
        .help-list li { margin-bottom: 8px; display: flex; gap: 8px; align-items: start; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ‚öôÔ∏è ZONA DE CONFIGURACI√ìN ‚öôÔ∏è
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAgO63zHV7R2A7PTTMPEpl28qpXnuv1jZE",
            authDomain: "wiki-amor.firebaseapp.com",
            projectId: "wiki-amor",
            storageBucket: "wiki-amor.firebasestorage.app",
            messagingSenderId: "676402129654",
            appId: "1:676402129654:web:199572eb9981cd10741ad7"
        };

        // Usamos el modelo 1.5 Flash que es m√°s estable para uso p√∫blico
        const GEMINI_MODEL = "gemini-1.5-flash"; 
        const GEMINI_API_KEY = "AIzaSyCh1ETP6wY9fO-nFsfmEYBcZgAB6G9LZ9ETe"; 

        // ==========================================
        
        // Inicializaci√≥n de Firebase con Persistencia
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
                // Habilitar persistencia offline (Mejora #2)
                firebase.firestore().enablePersistence().catch(err => {
                    console.log("Persistencia no habilitada (puede ser por m√∫ltiples pesta√±as abiertas):", err.code);
                });
            } catch (e) {
                console.error("Error iniciando Firebase.", e);
            }
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const collectionName = "pareja_wiki_data"; 

        const { useState, useEffect } = React;

        // --- COMPONENTES E ICONOS ---
        const Heart = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const Download = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const Trash2 = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const Edit2 = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const Search = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>;
        const User = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Plus = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>;
        const X = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>;
        const Cloud = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M4.5 19a5.5 5.5 0 1 1 3-10.16"/><path d="M19.5 19a5.5 5.5 0 1 0-3-10.16"/><line x1="1" y1="19" x2="23" y2="19"/></svg>;
        const Sparkles = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>;
        const Check = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const Dice = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><circle cx="15" cy="15" r="2"></circle></svg>;
        const AlertCircle = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const Brain = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>;
        const Clock = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const Info = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>;

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            return (<div className={`fixed bottom-4 right-4 ${bgClass} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-2 toast-enter z-50`}>{type === 'success' ? <Check size={18} /> : type === 'error' ? <X size={18} /> : <AlertCircle size={18} />}<span className="font-bold">{message}</span></div>);
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in p-4"><div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full"><h3 className="text-xl font-bold text-gray-800 mb-4">¬øEst√°s seguro?</h3><p className="text-gray-600 mb-6">{message}</p><div className="flex gap-3 justify-end"><button onClick={onClose} className="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-bold transition-colors">Cancelar</button><button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 font-bold shadow-lg transition-colors">S√≠, confirmar</button></div></div></div>);
        };

        // --- NUEVO COMPONENTE DE AYUDA ---
        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold text-gray-800 flex items-center gap-2">üìö Gu√≠a de Uso</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                        </div>
                        <div className="space-y-4 text-gray-600 help-list">
                            <div>
                                <h4 className="font-bold text-purple-600 flex items-center gap-2"><Search size={18}/> Modo Wiki</h4>
                                <p className="text-sm">Es la base de datos oficial. Aqu√≠ guardas datos concretos (tallas, gustos, alergias).</p>
                                <ul className="list-disc ml-5 text-xs mt-1 space-y-1">
                                    <li>Usa el bot√≥n "Flor" o "Tereque" para ver el perfil de cada uno.</li>
                                    <li>Usa el <strong>Or√°culo</strong> para preguntarle cosas a la IA sobre esa persona.</li>
                                </ul>
                            </div>
                            <hr/>
                            <div>
                                <h4 className="font-bold text-purple-600 flex items-center gap-2"><Dice size={18}/> Modo Juego</h4>
                                <p className="text-sm">Para divertirse y conocerse mejor.</p>
                                <ul className="list-disc ml-5 text-xs mt-1 space-y-1">
                                    <li>La IA genera una pregunta sorpresa.</li>
                                    <li>Si ambos responden, se guarda en la Wiki autom√°ticamente.</li>
                                    <li>Si solo uno responde, se guarda en <strong>Pendientes</strong> hasta que el otro responda su parte.</li>
                                </ul>
                            </div>
                            <div className="bg-blue-50 p-3 rounded-xl text-xs text-blue-700">
                                üí° <strong>Tip:</strong> Puedes descargar toda la info en Excel usando el bot√≥n <Download size={10} className="inline"/> arriba a la derecha.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeProfile, setActiveProfile] = useState('novia');
            const [viewMode, setViewMode] = useState('wiki');
            const [entries, setEntries] = useState([]);
            const [categories, setCategories] = useState(['B√°sica', 'Gustos', 'Dif√≠cil / Profunda', 'Familia', 'Historia', 'Curiosidad']);
            const [formData, setFormData] = useState({ category: '', question: '', answer: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [editingId, setEditingId] = useState(null);
            const [toast, setToast] = useState(null);
            const [deleteModal, setDeleteModal] = useState({ isOpen: false, id: null, type: null });
            const [helpModalOpen, setHelpModalOpen] = useState(false); // Estado ayuda
            
            const [aiQuery, setAiQuery] = useState('');
            const [aiResponse, setAiResponse] = useState('');
            const [isAiThinking, setIsAiThinking] = useState(false);
            const [gameQuestion, setGameQuestion] = useState('');
            const [isGeneratingGame, setIsGeneratingGame] = useState(false);
            const [answerFlor, setAnswerFlor] = useState('');
            const [answerTereque, setAnswerTereque] = useState('');
            const [pendingGames, setPendingGames] = useState([]);
            const [pendingAnswers, setPendingAnswers] = useState({});
            const [gameAnalysis, setGameAnalysis] = useState('');
            const [isAnalyzingGame, setIsAnalyzingGame] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Auth error:", error);
                        if(error.code === 'auth/invalid-api-key') {
                            showToast("Error de configuraci√≥n API", 'error');
                        }
                    }
                };
                initAuth();
                return auth.onAuthStateChanged((u) => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                return wikiRef.onSnapshot((snapshot) => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    setEntries(loaded); setIsLoading(false);
                }, (err) => { console.error(err); setIsLoading(false); });
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const pendingRef = db.collection(collectionName).doc('data').collection('pending_games');
                return pendingRef.orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    setPendingGames(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const catRef = db.collection(collectionName).doc('data').collection('settings').doc('categories');
                return catRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) { setCategories(docSnap.data().list || ['B√°sica']); }
                });
            }, [user]);

            const showToast = (message, type = 'success') => { setToast({ message, type }); };

            useEffect(() => { if (!formData.category && categories.length > 0) setFormData(prev => ({...prev, category: categories[0]})); }, [categories]);
            useEffect(() => {
                document.body.style.backgroundColor = viewMode === 'game' ? '#f3e8ff' : (activeProfile === 'novia' ? '#fff1f2' : '#eff6ff');
                setAiResponse(''); setAiQuery(''); setEditingId(null); setFormData(prev => ({ category: categories[0], question: '', answer: '' })); setGameAnalysis('');
            }, [activeProfile, viewMode]);

            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return showToast("Conectando...", 'error');
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                const data = { target: activeProfile, category: formData.category, question: formData.question, answer: formData.answer, date: new Date().toLocaleDateString(), timestamp: Date.now() };
                try {
                    if (editingId) { await wikiRef.doc(editingId).update({category: formData.category, question: formData.question, answer: formData.answer}); showToast("Actualizado ‚ú®"); setEditingId(null); }
                    else { await wikiRef.add(data); showToast("Guardado ‚ù§Ô∏è"); }
                    setFormData(prev => ({ ...prev, question: '', answer: '' }));
                } catch (err) { showToast("Error al guardar", 'error'); }
            };

            const handleEdit = (e) => { setEditingId(e.id); setFormData({ category: e.category, question: e.question, answer: e.answer }); window.scrollTo({top:0, behavior:'smooth'}); showToast("Editando...", 'success'); };
            const handleCancelEdit = () => { setEditingId(null); setFormData(prev => ({ ...prev, question: '', answer: '' })); };
            const handleDelete = (id) => setDeleteModal({ isOpen: true, id, type: 'wiki' });
            const confirmDelete = async () => {
                const { id, type } = deleteModal;
                if(type === 'wiki') { await db.collection(collectionName).doc('data').collection('wiki_entries').doc(id).delete(); if(editingId===id) handleCancelEdit(); showToast("Eliminado üóëÔ∏è"); }
                if(type === 'game_skip') { await db.collection(collectionName).doc('data').collection('pending_games').doc(id).delete(); showToast("Descartado"); }
                setDeleteModal({ isOpen: false, id: null, type: null });
            };

            const handleAddCategory = async () => {
                if(newCategoryName.trim() && !categories.includes(newCategoryName)) {
                    const newCats = [...categories, newCategoryName];
                    await db.collection(collectionName).doc('data').collection('settings').doc('categories').set({list: newCats});
                    setFormData(prev => ({...prev, category: newCategoryName})); setNewCategoryName(''); setIsAddingCategory(false);
                }
            };

            const downloadCSV = () => {
                let csv = "\uFEFFDe Qui√©n;Categor√≠a;Pregunta;Respuesta;Fecha\n";
                entries.filter(e => e.target === activeProfile).forEach(r => {
                    csv += `"${r.target==='novia'?'Flor':'Tereque'}";"${r.category}";"${(r.question||'').replace(/"/g,'""')}";"${(r.answer||'').replace(/"/g,'""')}";"${r.date}"\n`;
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
                link.download = "wiki_amor.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const fetchAI = async (prompt) => {
                if(!GEMINI_API_KEY.startsWith("AIza")) return "‚ö†Ô∏è Error: API Key inv√°lida.";
                try {
                    // Usamos el modelo configurado (1.5 Flash)
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const d = await res.json();
                    return d.candidates?.[0]?.content?.parts?.[0]?.text || "La IA est√° descansando üò¥";
                } catch (e) { return "Error de conexi√≥n con la IA."; }
            };

            const handleAskAI = async (e) => {
                e.preventDefault(); if(!aiQuery.trim()) return;
                setIsAiThinking(true);
                const context = entries.filter(x => x.target === activeProfile).map(x => `- ${x.category}: P:${x.question} R:${x.answer}`).join("\n");
                const resp = await fetchAI(`Experto en ${activeProfile==='novia'?'Flor':'Tereque'}. Datos: ${context}. Pregunta: ${aiQuery}. S√© breve y √∫til.`);
                setAiResponse(resp); setIsAiThinking(false);
            };

            const handleGenerateGameQuestion = async () => {
                setIsGeneratingGame(true); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                const q = await fetchAI("Genera una pregunta interesante para parejas (Flor y Tereque) para conocerse mejor. Solo la pregunta.");
                setGameQuestion(q); setIsGeneratingGame(false);
            };

            const handleAnalyzeGame = async () => {
                setIsAnalyzingGame(true);
                const resp = await fetchAI(`Analiza: Pregunta "${gameQuestion}". Flor: "${answerFlor}". Tereque: "${answerTereque}". Breve y divertido.`);
                setGameAnalysis(resp); setIsAnalyzingGame(false);
            };

            const handleSaveActiveGame = async () => {
                if(!gameQuestion) return;
                const hF = !!answerFlor.trim(), hT = !!answerTereque.trim();
                if(!hF && !hT) return showToast("Escribe algo", 'error');
                
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                const pendRef = db.collection(collectionName).doc('data').collection('pending_games');

                if(hF && hT) {
                    await wikiRef.add({target:'novia', category:'Juego AI üé≤', question:gameQuestion, answer:answerFlor, date:new Date().toLocaleDateString(), timestamp: Date.now()});
                    await wikiRef.add({target:'novio', category:'Juego AI üé≤', question:gameQuestion, answer:answerTereque, date:new Date().toLocaleDateString(), timestamp: Date.now()+1});
                    showToast("¬°Completado! üéâ"); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                } else {
                    await pendRef.add({question:gameQuestion, answerFlor, answerTereque, timestamp: Date.now()});
                    showToast("Guardado en pendientes ‚è≥"); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                }
            };

            const handleCompletePendingGame = async (game) => {
                const nF = pendingAnswers[`${game.id}_flor`] || game.answerFlor || '';
                const nT = pendingAnswers[`${game.id}_tereque`] || game.answerTereque || '';
                if(!nF.trim() || !nT.trim()) return; 

                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                await wikiRef.add({target:'novia', category:'Juego AI üé≤', question:game.question, answer:nF, date:new Date().toLocaleDateString(), timestamp: Date.now()});
                await wikiRef.add({target:'novio', category:'Juego AI üé≤', question:game.question, answer:nT, date:new Date().toLocaleDateString(), timestamp: Date.now()+1});
                await db.collection(collectionName).doc('data').collection('pending_games').doc(game.id).delete();
                showToast("¬°Turno completado! üéâ");
            };

            const handleSkipPendingGame = (id) => setDeleteModal({ isOpen: true, id, type: 'game_skip' });

            const theme = activeProfile === 'novia' ? { text: 'text-rose-600', bg: 'bg-rose-500', border: 'border-rose-400', gradient: 'from-rose-500 to-orange-400' } : { text: 'text-blue-600', bg: 'bg-blue-500', border: 'border-blue-400', gradient: 'from-blue-500 to-cyan-400' };
            
            if (!user) return <div className="min-h-screen flex flex-col items-center justify-center text-gray-500"><div className="spinner border-gray-400 mb-4"></div>Conectando con el amor...</div>;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto pb-20">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} />}
                    <ConfirmationModal isOpen={deleteModal.isOpen} onClose={()=>setDeleteModal({isOpen:false})} onConfirm={confirmDelete} message={deleteModal.type==='wiki'?"¬øBorrar recuerdo?":"¬øDescartar pregunta?"} />
                    <HelpModal isOpen={helpModalOpen} onClose={()=>setHelpModalOpen(false)} />
                    
                    {/* HEADER */}
                    <header className="mb-6 glass-panel p-2 rounded-3xl flex flex-wrap justify-between gap-4 sticky top-2 z-50">
                        <div className="flex gap-2 bg-gray-100 p-1 rounded-2xl items-center">
                            <button onClick={()=>setViewMode('wiki')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 ${viewMode==='wiki'?'bg-white shadow text-gray-800':'text-gray-400'}`}><Search size={18}/> Wiki</button>
                            <button onClick={()=>setViewMode('game')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 ${viewMode==='game'?'bg-purple-500 shadow text-white':'text-gray-400'} ${pendingGames.length>0?'pending-pulse':''}`}><Dice size={18}/> Juego {pendingGames.length>0 && <span className="bg-red-500 text-white text-xs px-1 rounded-full">{pendingGames.length}</span>}</button>
                            <button onClick={()=>setHelpModalOpen(true)} className="ml-2 p-2 text-gray-400 hover:text-purple-500"><Info size={20}/></button>
                        </div>
                        {viewMode==='wiki' && (
                            <div className="flex gap-2 bg-gray-100 p-1 rounded-2xl">
                                <button onClick={()=>setActiveProfile('novia')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 ${activeProfile==='novia'?'bg-white text-rose-600 shadow':'text-gray-400'}`}><Heart size={16}/> Flor</button>
                                <button onClick={()=>setActiveProfile('novio')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 ${activeProfile==='novio'?'bg-white text-blue-600 shadow':'text-gray-400'}`}><User size={16}/> Tereque</button>
                                <button onClick={downloadCSV} className="bg-gray-800 text-white p-2 rounded-xl"><Download size={16}/></button>
                            </div>
                        )}
                    </header>

                    {viewMode === 'game' ? (
                        <div className="fade-in max-w-3xl mx-auto space-y-8">
                            {/* GAME UI */}
                            <div className="game-gradient p-8 rounded-3xl shadow-2xl text-center text-white relative overflow-hidden">
                                <h2 className="text-3xl font-extrabold mb-4 relative z-10">‚ú® Preguntas de Pareja ‚ú®</h2>
                                {!gameQuestion ? (
                                    <button onClick={handleGenerateGameQuestion} disabled={isGeneratingGame} className="bg-white text-purple-600 px-8 py-4 rounded-full font-bold shadow-lg flex items-center gap-2 mx-auto relative z-10">{isGeneratingGame?<div className="spinner border-purple-600"/>:<><Sparkles/> Nueva Pregunta</>}</button>
                                ) : (
                                    <div className="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 relative z-10 text-left space-y-4">
                                        <h3 className="text-2xl font-bold text-center mb-4">"{gameQuestion}"</h3>
                                        <input value={answerFlor} onChange={e=>setAnswerFlor(e.target.value)} placeholder="Respuesta de Flor..." className="w-full p-3 rounded-xl text-gray-800 bg-white/90" />
                                        <input value={answerTereque} onChange={e=>setAnswerTereque(e.target.value)} placeholder="Respuesta de Tereque..." className="w-full p-3 rounded-xl text-gray-800 bg-white/90" />
                                        <div className="flex gap-2">
                                            <button onClick={handleSaveActiveGame} className="flex-1 bg-purple-600 text-white font-bold py-3 rounded-xl shadow">{answerFlor&&answerTereque?'Guardar Final':'Guardar Pendiente'}</button>
                                            <button onClick={()=>setGameQuestion('')} className="px-4 bg-white/20 text-white rounded-xl font-bold">Cancelar</button>
                                        </div>
                                        {answerFlor && answerTereque && <button onClick={handleAnalyzeGame} disabled={isAnalyzingGame} className="w-full text-white underline text-sm mt-2">{isAnalyzingGame?'Analizando...':'Opini√≥n IA'}</button>}
                                        {gameAnalysis && <div className="bg-purple-100 p-3 rounded-xl text-purple-800 text-sm mt-2 markdown-body" dangerouslySetInnerHTML={{__html: marked.parse(gameAnalysis)}}></div>}
                                    </div>
                                )}
                            </div>
                            
                            {/* PENDIENTES */}
                            {pendingGames.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-purple-800 mb-4 flex gap-2"><Clock/> Pendientes ({pendingGames.length})</h3>
                                    <div className="space-y-4">
                                        {pendingGames.map(g => (
                                            <div key={g.id} className="bg-white p-6 rounded-2xl shadow border-l-8 border-purple-300 relative">
                                                <button onClick={()=>handleSkipPendingGame(g.id)} className="absolute top-4 right-4 text-gray-300 hover:text-red-400"><Trash2 size={16}/></button>
                                                <h4 className="font-bold text-gray-800 mb-4 pr-8">"{g.question}"</h4>
                                                <div className="space-y-2">
                                                    <div className={`p-3 rounded-xl border ${g.answerFlor?'bg-rose-50 border-rose-100':'bg-white border-dashed border-rose-200'}`}>
                                                        <span className="text-xs font-bold text-rose-500 flex gap-1 mb-1"><Heart size={12}/> Flor {g.answerFlor && <Check size={14} className="text-green-500"/>}</span>
                                                        {g.answerFlor ? <p className="text-sm italic">"{g.answerFlor}"</p> : <textarea placeholder="Escribe..." className="w-full text-sm p-1 bg-transparent" onChange={(e)=>setPendingAnswers(p=>({...p, [`${g.id}_flor`]:e.target.value}))} value={pendingAnswers[`${g.id}_flor`]||''}/>}
                                                    </div>
                                                    <div className={`p-3 rounded-xl border ${g.answerTereque?'bg-blue-50 border-blue-100':'bg-white border-dashed border-blue-200'}`}>
                                                        <span className="text-xs font-bold text-blue-500 flex gap-1 mb-1"><User size={12}/> Tereque {g.answerTereque && <Check size={14} className="text-green-500"/>}</span>
                                                        {g.answerTereque ? <p className="text-sm italic">"{g.answerTereque}"</p> : <textarea placeholder="Escribe..." className="w-full text-sm p-1 bg-transparent" onChange={(e)=>setPendingAnswers(p=>({...p, [`${g.id}_tereque`]:e.target.value}))} value={pendingAnswers[`${g.id}_tereque`]||''}/>}
                                                    </div>
                                                    {(!g.answerFlor || !g.answerTereque) && <button onClick={()=>handleCompletePendingGame(g)} className="w-full py-2 bg-purple-100 text-purple-700 font-bold rounded-lg mt-2 text-sm">Enviar Respuesta</button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-12 gap-6 fade-in">
                            {/* WIKI FORM */}
                            <div className="md:col-span-4">
                                <div className={`glass-panel p-6 rounded-3xl sticky top-28 border-t-4 ${theme.border}`}>
                                    <h2 className={`text-xl font-bold mb-4 flex gap-2 ${theme.text}`}>{editingId?<Edit2/>:<Plus/>}{editingId?'Editar':'Nuevo'}</h2>
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        <div>
                                            <div className="flex justify-between mb-1"><label className="text-xs font-bold text-gray-500">CATEGOR√çA</label> {!isAddingCategory && <button type="button" onClick={()=>setIsAddingCategory(true)} className="text-xs underline text-gray-400">Nueva</button>}</div>
                                            {isAddingCategory ? <div className="flex gap-2"><input autoFocus placeholder="Nombre..." className="flex-1 p-2 border rounded text-sm" value={newCategoryName} onChange={e=>setNewCategoryName(e.target.value)}/><button type="button" onClick={handleAddCategory} className={`p-2 rounded text-white ${theme.bg}`}><Plus/></button></div> : <select name="category" value={formData.category} onChange={handleInputChange} className="w-full p-3 border rounded-xl bg-white">{categories.map(c=><option key={c}>{c}</option>)}</select>}
                                        </div>
                                        <input name="question" value={formData.question} onChange={handleInputChange} placeholder="Pregunta..." className="w-full p-3 border rounded-xl" required />
                                        <textarea name="answer" value={formData.answer} onChange={handleInputChange} placeholder="Respuesta..." className="w-full p-3 border rounded-xl h-24 resize-none" required />
                                        <div className="flex gap-2">{editingId && <button type="button" onClick={handleCancelEdit} className="px-4 bg-gray-200 rounded-xl font-bold">Cancelar</button>}<button type="submit" className={`flex-1 py-3 text-white font-bold rounded-xl shadow ${theme.bg}`}>{editingId?'Actualizar':'Guardar'}</button></div>
                                    </form>
                                </div>
                            </div>
                            {/* WIKI LIST & ORACLE */}
                            <div className="md:col-span-8 space-y-6">
                                <div className={`rounded-3xl p-6 text-white shadow-xl bg-gradient-to-r ${theme.gradient} relative overflow-hidden`}>
                                    <div className="absolute top-0 right-0 p-4 opacity-20"><Sparkles size={100}/></div>
                                    <h2 className="text-xl font-bold mb-2 flex gap-2"><Sparkles/> Or√°culo de {activeProfile==='novia'?'Flor':'Tereque'}</h2>
                                    <form onSubmit={handleAskAI} className="relative z-10 flex gap-2"><input value={aiQuery} onChange={e=>setAiQuery(e.target.value)} placeholder="Preg√∫ntale algo..." className="w-full p-3 rounded-xl text-gray-800" /><button type="submit" disabled={isAiThinking} className="bg-white/20 p-3 rounded-xl font-bold backdrop-blur">{isAiThinking?<div className="spinner border-white"/>:'Ir'}</button></form>
                                    {aiResponse && <div className="mt-4 bg-white/10 p-4 rounded-xl backdrop-blur markdown-body" dangerouslySetInnerHTML={{__html: marked.parse(aiResponse)}} />}
                                </div>
                                <div className="bg-white p-2 rounded-xl flex items-center border"><Search className="ml-2 text-gray-400"/><input placeholder="Buscar..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full p-2 outline-none"/></div>
                                <div className="grid gap-4">
                                    {entries.filter(e=>e.target===activeProfile && (e.question.toLowerCase().includes(searchTerm.toLowerCase()) || e.answer.toLowerCase().includes(searchTerm.toLowerCase()))).map(e => (
                                        <div key={e.id} className={`bg-white p-6 rounded-2xl shadow border relative group ${editingId===e.id?'ring-2 ring-rose-300':''}`}>
                                            <span className={`text-xs font-bold px-2 py-1 rounded-full bg-gray-100 text-gray-600`}>{e.category}</span>
                                            <h3 className="font-bold text-lg mt-2">{e.question}</h3>
                                            <p className="text-gray-600 mt-1 whitespace-pre-line">{e.answer}</p>
                                            <div className="mt-4 flex justify-between items-center pt-4 border-t">
                                                <span className="text-xs text-gray-400">{e.date}</span>
                                                <div className="flex gap-1"><button onClick={()=>handleEdit(e)} className="p-2 hover:bg-blue-50 rounded-full text-gray-400 hover:text-blue-500"><Edit2 size={16}/></button><button onClick={()=>handleDelete(e.id)} className="p-2 hover:bg-red-50 rounded-full text-gray-400 hover:text-red-500"><Trash2 size={16}/></button></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>