<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Nuestra Wiki de Amor ‚ù§Ô∏è</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Fuente Moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Nunito', sans-serif; 
            transition: background 0.8s ease, color 0.5s ease; 
            -webkit-tap-highlight-color: transparent;
            background-color: #020617; /* Slate 950 - Muy oscuro */
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Glassmorphism Moderno y Limpio */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        }

        /* Inputs profesionales */
        input, textarea, select {
            background-color: rgba(30, 41, 59, 0.5) !important; /* Slate 800 */
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #f1f5f9 !important;
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            background-color: rgba(30, 41, 59, 0.8) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.05);
        }
        input::placeholder, textarea::placeholder { color: #64748b !important; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .markdown-body p { margin-bottom: 0.8em; }
        
        /* Scrollbar Minimalista */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animaci√≥n de cartas especiales */
        @keyframes celebrate {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
            50% { transform: scale(1.02); box-shadow: 0 10px 30px -5px rgba(255,255,255,0.1); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
        }
        .celebration-card { animation: celebrate 3s infinite ease-in-out; }

        /* Toggle Switch Custom */
        .toggle-checkbox:checked { right: 0; border-color: #ffffff; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ffffff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ‚öôÔ∏è ZONA DE CONFIGURACI√ìN ‚öôÔ∏è
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAgO63zHV7R2A7PTTMPEpl28qpXnuv1jZE",
            authDomain: "wiki-amor.firebaseapp.com",
            projectId: "wiki-amor",
            storageBucket: "wiki-amor.firebasestorage.app",
            messagingSenderId: "676402129654",
            appId: "1:676402129654:web:199572eb9981cd10741ad7"
        };

        const GEMINI_MODELS_TO_TRY = [ "gemini-2.5-flash-preview-09-2025", "gemini-1.5-flash", "gemini-1.5-flash-001", "gemini-1.5-pro" ];
        const GEMINI_API_KEY = "AIzaSyCh1ETP6wY9fO-nFsfmEYBcZgAB6G9LZ9E"; 

        // ==========================================
        
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
                firebase.firestore().enablePersistence().catch(err => console.log("Persistencia:", err.code));
            } catch (e) { console.error("Error Firebase", e); }
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const collectionName = "pareja_wiki_data"; 

        const { useState, useEffect } = React;

        // --- ICONOS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Heart = (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Edit2 = (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></IconBase>;
        const Cloud = (p) => <IconBase {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M4.5 19a5.5 5.5 0 1 1 3-10.16"/><path d="M19.5 19a5.5 5.5 0 1 0-3-10.16"/><line x1="1" y1="19" x2="23" y2="19"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconBase>;
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Dice = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><circle cx="15" cy="15" r="2"></circle></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconBase>;
        const CalendarIcon = (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>;
        const Bell = (p) => <IconBase {...p}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></IconBase>;
        const Repeat = (p) => <IconBase {...p}><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></IconBase>;

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 4000); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'success' ? 'bg-green-900/80 border-green-500 text-green-100' : 
                           type === 'error' ? 'bg-red-900/80 border-red-500 text-red-100' : 
                           'bg-blue-900/80 border-blue-500 text-blue-100';
            const icon = type === 'success' ? <Check size={18} /> : type === 'error' ? <X size={18} /> : type === 'info' ? <Bell size={18} /> : <AlertCircle size={18} />;
            return (<div className={`fixed bottom-4 right-4 ${bgClass} border px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 toast-enter z-[100] backdrop-blur`}>{icon}<span className="font-bold">{message}</span></div>);
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (<div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 fade-in p-4"><div className="glass-panel p-8 rounded-3xl shadow-2xl max-w-sm w-full bg-[#0f172a]"><h3 className="text-xl font-bold text-white mb-4">¬øEst√°s seguro?</h3><p className="text-gray-400 mb-8 text-sm">{message}</p><div className="flex gap-3 justify-end"><button onClick={onClose} className="px-5 py-2.5 rounded-xl text-gray-300 hover:bg-white/5 font-bold transition-colors text-sm">Cancelar</button><button onClick={onConfirm} className="px-5 py-2.5 rounded-xl bg-red-600 text-white hover:bg-red-700 font-bold shadow-lg transition-colors text-sm">S√≠, confirmar</button></div></div></div>);
        };

        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 fade-in p-4">
                    <div className="glass-panel p-8 rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto" style={{backgroundColor: '#0f172a'}}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-bold text-white flex items-center gap-3">üìö Gu√≠a R√°pida</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-white transition-colors"><X size={24}/></button>
                        </div>
                        <div className="space-y-6 text-gray-400 help-list">
                            <div><h4 className="font-bold text-white flex items-center gap-2 text-lg mb-1"><Search size={20} className="text-sky-400"/> Wiki</h4><p className="text-sm leading-relaxed">Tu enciclopedia personal. Guarda datos como tallas, alergias o gustos. √ösala para no olvidar detalles importantes.</p></div>
                            <div className="h-px bg-white/10 w-full"></div>
                            <div><h4 className="font-bold text-white flex items-center gap-2 text-lg mb-1"><Dice size={20} className="text-purple-400"/> Juego</h4><p className="text-sm leading-relaxed">Genera preguntas aleatorias para conocerse mejor. Si solo uno responde, se guarda en pendientes hasta que el otro responda.</p></div>
                            <div className="h-px bg-white/10 w-full"></div>
                            <div><h4 className="font-bold text-white flex items-center gap-2 text-lg mb-1"><CalendarIcon size={20} className="text-orange-400"/> Fechas</h4><p className="text-sm leading-relaxed">Control de aniversarios y cumplea√±os. La app te avisa 3 d√≠as antes.</p></div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeProfile, setActiveProfile] = useState('novia');
            const [viewMode, setViewMode] = useState('wiki');
            const [entries, setEntries] = useState([]);
            const [categories, setCategories] = useState(['B√°sica', 'Gustos', 'Dif√≠cil / Profunda', 'Familia', 'Historia', 'Curiosidad']);
            const [formData, setFormData] = useState({ category: '', question: '', answer: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [editingId, setEditingId] = useState(null);
            const [toast, setToast] = useState(null);
            const [deleteModal, setDeleteModal] = useState({ isOpen: false, id: null, type: null });
            const [helpModalOpen, setHelpModalOpen] = useState(false); 
            const [aiQuery, setAiQuery] = useState('');
            const [aiResponse, setAiResponse] = useState('');
            const [isAiThinking, setIsAiThinking] = useState(false);
            const [gameQuestion, setGameQuestion] = useState('');
            const [isGeneratingGame, setIsGeneratingGame] = useState(false);
            const [answerFlor, setAnswerFlor] = useState('');
            const [answerTereque, setAnswerTereque] = useState('');
            const [pendingGames, setPendingGames] = useState([]);
            const [pendingAnswers, setPendingAnswers] = useState({});
            const [gameAnalysis, setGameAnalysis] = useState('');
            const [isAnalyzingGame, setIsAnalyzingGame] = useState(false);
            
            const [datesList, setDatesList] = useState([]);
            const [newDateTitle, setNewDateTitle] = useState('');
            const [newDateValue, setNewDateValue] = useState('');
            const [newDateRepeats, setNewDateRepeats] = useState(true);
            const [relationshipStart, setRelationshipStart] = useState(null);
            const [showDateInput, setShowDateInput] = useState(false);
            const [editingDateId, setEditingDateId] = useState(null);

            useEffect(() => {
                const initAuth = async () => {
                    try { await auth.signInAnonymously(); } catch (error) { showToast("Error Auth", 'error'); }
                };
                initAuth();
                return auth.onAuthStateChanged((u) => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                return wikiRef.onSnapshot((snapshot) => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    setEntries(loaded); setIsLoading(false);
                }, (err) => { setIsLoading(false); });
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const pendingRef = db.collection(collectionName).doc('data').collection('pending_games');
                return pendingRef.orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    setPendingGames(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const datesRef = db.collection(collectionName).doc('data').collection('important_dates');
                const unsubDates = datesRef.onSnapshot((snapshot) => {
                    const loadedDates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setDatesList(loadedDates);
                    checkUpcomingDates(loadedDates); 
                });
                
                const relRef = db.collection(collectionName).doc('data').collection('settings').doc('relationship');
                const unsubRel = relRef.onSnapshot(doc => {
                    if(doc.exists) setRelationshipStart(doc.data().date);
                });

                return () => { unsubDates(); unsubRel(); };
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const catRef = db.collection(collectionName).doc('data').collection('settings').doc('categories');
                return catRef.onSnapshot((docSnap) => { if (docSnap.exists) { setCategories(docSnap.data().list || ['B√°sica']); } });
            }, [user]);

            const showToast = (message, type = 'success') => { setToast({ message, type }); };

            useEffect(() => { if (!formData.category && categories.length > 0) setFormData(prev => ({...prev, category: categories[0]})); }, [categories]);
            
            // --- L√ìGICA DE COLOR POR PERFIL ---
            useEffect(() => {
                if(activeProfile === 'novia') {
                    // ROJO VINO / BORGO√ëA
                    document.body.style.background = "radial-gradient(circle at 50% 0%, #4a0404 0%, #0a0000 100%)";
                } else {
                    // AZUL OSCURO PROFUNDO
                    document.body.style.background = "radial-gradient(circle at 50% 0%, #0f172a 0%, #020617 100%)";
                }
                
                setAiResponse(''); setAiQuery(''); setEditingId(null); setFormData(prev => ({ category: categories[0], question: '', answer: '' })); setGameAnalysis('');
                setEditingDateId(null); setNewDateTitle(''); setNewDateValue(''); setNewDateRepeats(true);
            }, [activeProfile, viewMode]);

            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return showToast("Conectando...", 'error');
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                const data = { target: activeProfile, category: formData.category, question: formData.question, answer: formData.answer, date: new Date().toLocaleDateString(), timestamp: Date.now() };
                try {
                    if (editingId) { await wikiRef.doc(editingId).update({category: formData.category, question: formData.question, answer: formData.answer}); showToast("Actualizado ‚ú®"); setEditingId(null); }
                    else { await wikiRef.add(data); showToast("Guardado ‚ù§Ô∏è"); }
                    setFormData(prev => ({ ...prev, question: '', answer: '' }));
                } catch (err) { showToast("Error al guardar", 'error'); }
            };

            const handleEdit = (e) => { setEditingId(e.id); setFormData({ category: e.category, question: e.question, answer: e.answer }); window.scrollTo({top:0, behavior:'smooth'}); showToast("Editando...", 'info'); };
            const handleCancelEdit = () => { setEditingId(null); setFormData(prev => ({ ...prev, question: '', answer: '' })); };
            const handleDelete = (id) => setDeleteModal({ isOpen: true, id, type: 'wiki' });
            const confirmDelete = async () => {
                const { id, type } = deleteModal;
                if (!id) return;
                if(type === 'wiki') { await db.collection(collectionName).doc('data').collection('wiki_entries').doc(id).delete(); if(editingId===id) handleCancelEdit(); showToast("Eliminado üóëÔ∏è"); }
                else if(type === 'game_skip') { await db.collection(collectionName).doc('data').collection('pending_games').doc(id).delete(); showToast("Descartado"); }
                else if(type === 'date') { await db.collection(collectionName).doc('data').collection('important_dates').doc(id).delete(); showToast("Fecha eliminada"); }
                setDeleteModal({ isOpen: false, id: null, type: null });
            };

            const handleAddCategory = async () => {
                if(newCategoryName.trim() && !categories.includes(newCategoryName)) {
                    const newCats = [...categories, newCategoryName];
                    await db.collection(collectionName).doc('data').collection('settings').doc('categories').set({list: newCats});
                    setFormData(prev => ({...prev, category: newCategoryName})); setNewCategoryName(''); setIsAddingCategory(false);
                }
            };

            const downloadCSV = () => {
                let csv = "\uFEFFDe Qui√©n;Categor√≠a;Pregunta;Respuesta;Fecha\n";
                entries.filter(e => e.target === activeProfile).forEach(r => {
                    csv += `"${r.target==='novia'?'Flor':'Terequito'}";"${r.category}";"${(r.question||'').replace(/"/g,'""')}";"${(r.answer||'').replace(/"/g,'""')}";"${r.date}"\n`;
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
                link.download = "wiki_amor.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const fetchAI = async (prompt) => {
                if(!GEMINI_API_KEY.startsWith("AIza")) return "‚ö†Ô∏è Error API Key";
                const safetySettings = [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" } ];
                for (const model of GEMINI_MODELS_TO_TRY) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], safetySettings: safetySettings }) });
                        const d = await res.json();
                        if (d.error) throw new Error(d.error.message);
                        return d.candidates?.[0]?.content?.parts?.[0]?.text || "La IA no respondi√≥.";
                    } catch (e) { continue; }
                }
                return "‚ö†Ô∏è La IA est√° durmiendo.";
            };

            const handleAskAI = async (e) => {
                e.preventDefault(); if(!aiQuery.trim()) return;
                setIsAiThinking(true);
                const context = entries.filter(x => x.target === activeProfile).map(x => `- ${x.category}: P:${x.question} R:${x.answer}`).join("\n");
                const resp = await fetchAI(`Experto en ${activeProfile==='novia'?'Flor':'Terequito'}. Datos: ${context}. Pregunta: ${aiQuery}. Responde breve y cari√±oso.`);
                setAiResponse(resp); setIsAiThinking(false);
            };

            const handleGenerateGameQuestion = async () => {
                setIsGeneratingGame(true); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                const q = await fetchAI("Genera una pregunta interesante para parejas (Flor y Terequito) para conocerse mejor. Solo la pregunta.");
                setGameQuestion(q); setIsGeneratingGame(false);
            };

            const handleAnalyzeGame = async () => {
                setIsAnalyzingGame(true);
                const resp = await fetchAI(`Analiza: Pregunta "${gameQuestion}". Flor: "${answerFlor}". Terequito: "${answerTereque}". Breve y divertido.`);
                setGameAnalysis(resp); setIsAnalyzingGame(false);
            };

            const handleSaveActiveGame = async () => {
                if(!gameQuestion) return;
                const hF = !!answerFlor.trim(), hT = !!answerTereque.trim();
                if(!hF && !hT) return showToast("Escribe algo", 'error');
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                const pendRef = db.collection(collectionName).doc('data').collection('pending_games');
                if(hF && hT) {
                    await wikiRef.add({target:'novia', category:'Juego AI üé≤', question:gameQuestion, answer:answerFlor, date:new Date().toLocaleDateString(), timestamp: Date.now()});
                    await wikiRef.add({target:'novio', category:'Juego AI üé≤', question:gameQuestion, answer:answerTereque, date:new Date().toLocaleDateString(), timestamp: Date.now()+1});
                    showToast("¬°Completado! üéâ"); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                } else {
                    await pendRef.add({question:gameQuestion, answerFlor, answerTereque, timestamp: Date.now()});
                    showToast("Guardado en pendientes ‚è≥"); setGameQuestion(''); setAnswerFlor(''); setAnswerTereque('');
                }
            };

            const handleCompletePendingGame = async (game) => {
                const nF = pendingAnswers[`${game.id}_flor`] || game.answerFlor || '';
                const nT = pendingAnswers[`${game.id}_tereque`] || game.answerTereque || '';
                if(!nF.trim() || !nT.trim()) return; 
                const wikiRef = db.collection(collectionName).doc('data').collection('wiki_entries');
                await wikiRef.add({target:'novia', category:'Juego AI üé≤', question:game.question, answer:nF, date:new Date().toLocaleDateString(), timestamp: Date.now()});
                await wikiRef.add({target:'novio', category:'Juego AI üé≤', question:game.question, answer:nT, date:new Date().toLocaleDateString(), timestamp: Date.now()+1});
                await db.collection(collectionName).doc('data').collection('pending_games').doc(game.id).delete();
                showToast("¬°Turno completado! üéâ");
            };

            const handleSkipPendingGame = (id) => setDeleteModal({ isOpen: true, id, type: 'game_skip' });
            const handleSaveDate = async (e) => {
                e.preventDefault();
                if(!newDateTitle || !newDateValue) return;
                const datesRef = db.collection(collectionName).doc('data').collection('important_dates');
                try {
                    if (editingDateId) { await datesRef.doc(editingDateId).update({ title: newDateTitle, date: newDateValue, repeats: newDateRepeats }); showToast("Fecha actualizada ‚ú®"); setEditingDateId(null); } 
                    else { await datesRef.add({ title: newDateTitle, date: newDateValue, repeats: newDateRepeats, timestamp: Date.now() }); showToast("Fecha guardada üìÖ"); }
                    setNewDateTitle(''); setNewDateValue(''); setNewDateRepeats(true);
                } catch (error) { showToast("Error al guardar fecha", 'error'); }
            };
            const handleDeleteDate = (id) => setDeleteModal({ isOpen: true, id, type: 'date' });
            const handleEditDate = (date) => { setEditingDateId(date.id); setNewDateTitle(date.title); setNewDateValue(date.date); setNewDateRepeats(date.repeats !== false); window.scrollTo({ top: 0, behavior: 'smooth' }); showToast("Editando fecha...", 'info'); };
            const handleCancelDateEdit = () => { setEditingDateId(null); setNewDateTitle(''); setNewDateValue(''); setNewDateRepeats(true); };
            const handleSaveRelationshipDate = async () => { if (!newDateValue) return; await db.collection(collectionName).doc('data').collection('settings').doc('relationship').set({ date: newDateValue }); showToast("¬°Historia iniciada! ‚ù§Ô∏è"); setShowDateInput(false); setNewDateValue(''); };
            
            const formatDateDisplay = (isoDateString) => {
                if (!isoDateString) return "";
                const [y, m, d] = isoDateString.split('-');
                const date = new Date(y, m - 1, d);
                return date.toLocaleDateString();
            };

            const getDaysUntil = (dateObjOrString) => {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const dateString = typeof dateObjOrString === 'string' ? dateObjOrString : dateObjOrString.date;
                const repeats = typeof dateObjOrString === 'string' ? true : (dateObjOrString.repeats !== false);
                const [y, m, d] = dateString.split('-').map(Number);
                if (repeats) {
                    let target = new Date(today.getFullYear(), m - 1, d);
                    if (target < today) target.setFullYear(today.getFullYear() + 1);
                    return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                } else {
                    let target = new Date(y, m - 1, d);
                    return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                }
            };

            const calculateDuration = (dateString) => {
                if(!dateString) return {years:0, months:0, days:0};
                const [y, m, d] = dateString.split('-').map(Number);
                const start = new Date(y, m-1, d);
                const now = new Date();
                now.setHours(0,0,0,0);
                let years = now.getFullYear() - start.getFullYear();
                let months = now.getMonth() - start.getMonth();
                let days = now.getDate() - start.getDate();
                if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                if (months < 0) { years--; months += 12; }
                return {years, months, days};
            };

            const checkUpcomingDates = (dates) => {
                const upcoming = dates.filter(d => { const days = getDaysUntil(d); return days >= 0 && days <= 3; });
                if (upcoming.length > 0) {
                    const closest = upcoming.sort((a,b) => getDaysUntil(a) - getDaysUntil(b))[0];
                    const days = getDaysUntil(closest);
                    if (days === 0) showToast(`üéâ ¬°HOY ES ${closest.title.toUpperCase()}! üéâ`, 'success');
                    else showToast(`üìÖ ¬°Faltan ${days} d√≠as para ${closest.title}!`, 'info');
                }
            };
            
            if (!user) return <div className="min-h-screen flex flex-col items-center justify-center text-gray-400"><div className="spinner border-rose-500 mb-4"></div>Iniciando...</div>;

            const duration = calculateDuration(relationshipStart);
            const daysToAnniversary = relationshipStart ? getDaysUntil({date: relationshipStart, repeats: true}) : 0;

            // Configuraci√≥n de Tema por Perfil
            const theme = activeProfile === 'novia' 
                ? { 
                    accent: 'text-rose-500', 
                    accentHover: 'hover:text-rose-400',
                    border: 'border-rose-900', 
                    btnBg: 'bg-gradient-to-r from-rose-900 to-red-900 hover:from-rose-800 hover:to-red-800',
                    ring: 'focus:ring-rose-900',
                    glass: 'rgba(40, 10, 20, 0.7)',
                    glow: 'shadow-rose-900/20',
                    labelColor: 'text-rose-200'
                  } 
                : { 
                    accent: 'text-sky-500', 
                    accentHover: 'hover:text-sky-400',
                    border: 'border-sky-900', 
                    btnBg: 'bg-gradient-to-r from-sky-900 to-blue-900 hover:from-sky-800 hover:to-blue-800',
                    ring: 'focus:ring-sky-900',
                    glass: 'rgba(10, 20, 40, 0.7)',
                    glow: 'shadow-sky-900/20',
                    labelColor: 'text-sky-200'
                  };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto pb-24">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} />}
                    <ConfirmationModal isOpen={deleteModal.isOpen} onClose={()=>setDeleteModal({isOpen:false})} onConfirm={confirmDelete} message={deleteModal.type==='wiki'?"¬øBorrar recuerdo?":deleteModal.type==='date'?"¬øBorrar fecha importante?":"¬øDescartar pregunta?"} />
                    <HelpModal isOpen={helpModalOpen} onClose={()=>setHelpModalOpen(false)} />
                    
                    {/* HEADER */}
                    <header className="mb-8 glass-panel p-3 rounded-3xl flex flex-wrap justify-between gap-4 sticky top-4 z-50" style={{backgroundColor: theme.glass, borderColor: 'rgba(255,255,255,0.05)'}}>
                        <div className="flex gap-3 items-center">
                            <button onClick={()=>setViewMode('wiki')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 transition-all ${viewMode==='wiki' ? 'bg-white/10 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'}`}><Search size={20}/> Wiki</button>
                            <button onClick={()=>setViewMode('game')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 transition-all ${viewMode==='game' ? 'bg-purple-900/50 text-purple-200 shadow-lg border border-purple-500/30' : 'text-gray-500 hover:text-gray-300'} ${pendingGames.length>0?'pending-pulse':''}`}><Dice size={20}/> Juego {pendingGames.length>0 && <span className="bg-red-600 text-white text-xs px-1.5 rounded-full ml-1">{pendingGames.length}</span>}</button>
                            <button onClick={()=>setViewMode('dates')} className={`px-4 py-2 rounded-xl font-bold flex gap-2 transition-all ${viewMode==='dates' ? 'bg-orange-900/50 text-orange-200 shadow-lg border border-orange-500/30' : 'text-gray-500 hover:text-gray-300'}`}><CalendarIcon size={20}/> Fechas</button>
                        </div>
                        <div className="flex items-center gap-4">
                            {viewMode==='wiki' && (
                                <div className="flex bg-black/30 p-1 rounded-xl border border-white/5">
                                    <button onClick={()=>setActiveProfile('novia')} className={`px-4 py-1.5 rounded-lg font-bold flex gap-2 text-sm transition-all ${activeProfile==='novia'?'bg-rose-900/80 text-white shadow-md':'text-gray-500 hover:text-gray-300'}`}><Heart size={14} className={activeProfile==='novia'?'fill-current':''}/> Flor de Desierto</button>
                                    <button onClick={()=>setActiveProfile('novio')} className={`px-4 py-1.5 rounded-lg font-bold flex gap-2 text-sm transition-all ${activeProfile==='novio'?'bg-sky-900/80 text-white shadow-md':'text-gray-500 hover:text-gray-300'}`}><User size={14} className={activeProfile==='novio'?'fill-current':''}/> Terequito</button>
                                </div>
                            )}
                             <button onClick={()=>setHelpModalOpen(true)} className="p-2 text-gray-500 hover:text-white transition-colors"><Info size={22}/></button>
                             {viewMode==='wiki' && <button onClick={downloadCSV} className="p-2 text-gray-500 hover:text-white transition-colors" title="Descargar Excel"><Download size={22}/></button>}
                        </div>
                    </header>

                    {viewMode === 'dates' && (
                        <div className="fade-in max-w-3xl mx-auto space-y-8">
                            
                            {/* TARJETA DE HISTORIA */}
                            <div className="glass-panel p-8 rounded-3xl shadow-xl border-t-2 border-orange-500 relative overflow-hidden">
                                <div className="absolute top-0 right-0 opacity-10 p-4"><Heart size={120} className="text-red-500"/></div>
                                <h2 className="text-3xl font-bold text-orange-200 mb-6 flex items-center gap-3"><Heart className="text-red-500"/> Nuestra Historia</h2>
                                
                                {relationshipStart && !showDateInput ? (
                                    <div className="space-y-6 relative z-10">
                                        <div className="grid grid-cols-3 gap-4 text-center">
                                            <div className="bg-white/5 p-4 rounded-2xl border border-white/10"><p className="text-4xl font-bold text-white">{duration.years}</p><p className="text-gray-400 text-xs uppercase tracking-wide font-bold">A√±os</p></div>
                                            <div className="bg-white/5 p-4 rounded-2xl border border-white/10"><p className="text-4xl font-bold text-white">{duration.months}</p><p className="text-gray-400 text-xs uppercase tracking-wide font-bold">Meses</p></div>
                                            <div className="bg-white/5 p-4 rounded-2xl border border-white/10"><p className="text-4xl font-bold text-white">{duration.days}</p><p className="text-gray-400 text-xs uppercase tracking-wide font-bold">D√≠as</p></div>
                                        </div>
                                        <div className="bg-gradient-to-r from-red-900/80 to-orange-900/80 text-white p-4 rounded-xl flex justify-between items-center shadow-lg border border-red-800/50">
                                            <div>
                                                <p className="text-orange-200 text-sm uppercase font-bold">Pr√≥ximo Aniversario</p>
                                                <p className="font-bold text-lg text-white">Faltan {daysToAnniversary} d√≠as üéâ</p>
                                            </div>
                                            <button onClick={()=>setShowDateInput(true)} className="text-orange-200 hover:text-white"><Edit2 size={18}/></button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-4 relative z-10">
                                        <p className="text-gray-300 mb-4">¬øCu√°ndo comenz√≥ su historia?</p>
                                        <div className="flex gap-2 justify-center">
                                            <input type="date" value={newDateValue} onChange={e=>setNewDateValue(e.target.value)} className="p-3 border rounded-xl" />
                                            <button onClick={handleSaveRelationshipDate} className="bg-gradient-to-r from-orange-700 to-red-700 text-white px-6 py-3 rounded-xl font-bold shadow hover:from-orange-600 hover:to-red-600">Guardar Inicio</button>
                                            {relationshipStart && <button onClick={()=>setShowDateInput(false)} className="text-gray-400 px-3">Cancelar</button>}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* AGREGAR / EDITAR FECHA */}
                            <div className="glass-panel p-8 rounded-3xl shadow-xl text-center text-white border-t-2 border-white/10">
                                <h2 className="text-2xl font-bold mb-6 text-orange-200 text-left flex gap-2 items-center"><CalendarIcon/> {editingDateId ? 'Editar Fecha' : 'Eventos Especiales'}</h2>
                                <form onSubmit={handleSaveDate} className="flex flex-col gap-4 bg-black/20 p-4 rounded-2xl text-left border border-white/5">
                                    <div className="flex flex-col md:flex-row gap-4">
                                        <input value={newDateTitle} onChange={e=>setNewDateTitle(e.target.value)} placeholder="T√≠tulo (ej: Viaje a Par√≠s)" className="flex-1 p-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-orange-500/50" required />
                                        <input type="date" value={newDateValue} onChange={e=>setNewDateValue(e.target.value)} className="p-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-orange-500/50" required />
                                    </div>
                                    <div className="flex items-center justify-between bg-white/5 p-3 rounded-xl">
                                        <label className="flex items-center gap-3 cursor-pointer select-none">
                                            <input type="checkbox" checked={newDateRepeats} onChange={e=>setNewDateRepeats(e.target.checked)} className="w-5 h-5 rounded bg-transparent border-orange-500 text-orange-500 focus:ring-0" />
                                            <span className="text-sm font-bold text-gray-300">Repetir cada a√±o <span className="font-normal opacity-60 block text-xs">(Cumplea√±os, Aniversarios)</span></span>
                                        </label>
                                        <div className="flex gap-3">
                                            {editingDateId && <button type="button" onClick={handleCancelDateEdit} className="text-gray-400 hover:text-white font-bold px-4 py-2">Cancelar</button>}
                                            <button type="submit" className="bg-orange-700 hover:bg-orange-600 text-white font-bold px-6 py-2 rounded-xl shadow transition-colors">{editingDateId ? 'Actualizar' : 'Agregar'}</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            {/* LISTA DE FECHAS */}
                            <div className="grid gap-4">
                                {datesList.sort((a,b) => getDaysUntil(a) - getDaysUntil(b)).map(date => {
                                    const daysLeft = getDaysUntil(date);
                                    const isToday = daysLeft === 0;
                                    const isPast = daysLeft < 0;
                                    const isEditing = editingDateId === date.id;
                                    const cardClass = isEditing ? 'border-orange-500 ring-1 ring-orange-500 bg-orange-900/20' : isToday ? 'border-yellow-500 celebration-card bg-yellow-900/20' : isPast ? 'border-gray-700 opacity-60 bg-black/40' : 'border-white/10 bg-black/20';
                                    return (
                                        <div key={date.id} className={`p-6 rounded-2xl shadow border-l-4 relative flex items-center justify-between backdrop-blur-md transition-all ${cardClass}`}>
                                            <div>
                                                <h3 className="font-bold text-xl text-white flex items-center gap-3">
                                                    {date.title}
                                                    {date.repeats !== false && <Repeat size={16} className="text-gray-500" title="Se repite anualmente"/>}
                                                </h3>
                                                <p className="text-gray-400 text-sm flex items-center gap-2 mt-1">
                                                    <CalendarIcon size={16} className="text-gray-500"/> {formatDateDisplay(date.date)} 
                                                    {isToday ? 
                                                        <span className="bg-yellow-600 text-white px-2 py-0.5 rounded text-xs font-bold">¬°HOY!</span> : 
                                                        isPast ? 
                                                            <span className="bg-gray-800 text-gray-500 px-2 py-0.5 rounded text-xs border border-gray-700">Pas√≥ hace {Math.abs(daysLeft)} d√≠as</span> : 
                                                            <span className="bg-orange-900/40 text-orange-200 px-2 py-0.5 rounded text-xs border border-orange-800/50">Faltan {daysLeft} d√≠as</span>
                                                    }
                                                </p>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                {isToday && <span className="text-2xl animate-bounce mr-2">üéâ</span>}
                                                <button onClick={()=>handleEditDate(date)} className="text-gray-500 hover:text-blue-400 p-2 rounded-lg hover:bg-white/5 transition-all" title="Editar"><Edit2 size={18}/></button>
                                                <button onClick={()=>handleDeleteDate(date.id)} className="text-gray-500 hover:text-red-400 p-2 rounded-lg hover:bg-white/5 transition-all" title="Eliminar"><Trash2 size={18}/></button>
                                            </div>
                                        </div>
                                    );
                                })}
                                {datesList.length === 0 && <p className="text-center text-gray-500 mt-8 font-italic">No hay fechas guardadas a√∫n.</p>}
                            </div>
                        </div>
                    )}

                    {viewMode === 'game' && (
                        <div className="fade-in max-w-3xl mx-auto space-y-8">
                            <div className="glass-panel p-8 rounded-3xl text-center relative overflow-hidden border-t-4 border-purple-600">
                                <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-purple-900/20 to-transparent opacity-50"></div>
                                <h2 className="text-3xl font-bold mb-6 relative z-10 text-white drop-shadow-md">‚ú® Preguntas de Pareja ‚ú®</h2>
                                {!gameQuestion ? (
                                    <button onClick={handleGenerateGameQuestion} disabled={isGeneratingGame} className="bg-white/10 text-purple-200 px-8 py-4 rounded-2xl font-bold shadow-lg flex items-center gap-3 mx-auto relative z-10 backdrop-blur-md border border-purple-500/30 hover:bg-white/20 transition-all hover:scale-105">{isGeneratingGame?<div className="spinner border-purple-400"/>:<><Sparkles/> Nueva Pregunta M√°gica</>}</button>
                                ) : (
                                    <div className="bg-black/40 backdrop-blur-md p-8 rounded-2xl border border-white/10 relative z-10 text-left space-y-6">
                                        <h3 className="text-2xl font-bold text-center mb-6 text-white leading-relaxed">"{gameQuestion}"</h3>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="bg-rose-900/10 p-4 rounded-2xl border border-rose-500/20">
                                                <p className="text-xs text-rose-400 font-bold mb-2 uppercase tracking-wider">Respuesta de Flor</p>
                                                <textarea value={answerFlor} onChange={e=>setAnswerFlor(e.target.value)} placeholder="Escribe aqu√≠..." className="w-full p-3 rounded-xl bg-black/30 text-white h-24 resize-none border border-white/5 focus:border-rose-500/50"></textarea>
                                            </div>
                                            <div className="bg-sky-900/10 p-4 rounded-2xl border border-sky-500/20">
                                                <p className="text-xs text-sky-400 font-bold mb-2 uppercase tracking-wider">Respuesta de Terequito</p>
                                                <textarea value={answerTereque} onChange={e=>setAnswerTereque(e.target.value)} placeholder="Escribe aqu√≠..." className="w-full p-3 rounded-xl bg-black/30 text-white h-24 resize-none border border-white/5 focus:border-sky-500/50"></textarea>
                                            </div>
                                        </div>
                                        <div className="flex gap-3 pt-2">
                                            <button onClick={handleSaveActiveGame} className="flex-1 bg-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-purple-600 transition-all">{answerFlor&&answerTereque?'Guardar en Wiki':'Guardar Pendiente'}</button>
                                            <button onClick={()=>setGameQuestion('')} className="px-6 bg-white/5 text-gray-400 rounded-xl font-bold hover:bg-white/10 hover:text-white transition-all border border-white/5">Cancelar</button>
                                        </div>
                                        {answerFlor && answerTereque && <button onClick={handleAnalyzeGame} disabled={isAnalyzingGame} className="w-full text-purple-300 hover:text-white underline text-sm mt-4 transition-colors text-center">{isAnalyzingGame?'La IA est√° pensando...':'üîÆ ¬øQu√© opina la IA?'}</button>}
                                        {gameAnalysis && <div className="mt-4 bg-purple-900/30 border-l-4 border-purple-500 p-4 rounded-r-xl text-purple-100 text-sm leading-relaxed shadow-lg" dangerouslySetInnerHTML={{__html: marked.parse(gameAnalysis)}}></div>}
                                    </div>
                                )}
                            </div>
                            
                            {pendingGames.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-gray-400 mb-6 flex gap-2 items-center"><Clock className="text-purple-500"/> Turnos Pendientes</h3>
                                    <div className="grid gap-4">
                                        {pendingGames.map(g => (
                                            <div key={g.id} className="glass-panel p-6 rounded-2xl border-l-4 border-purple-600 relative group hover:bg-white/5 transition-colors">
                                                <button onClick={()=>handleSkipPendingGame(g.id)} className="absolute top-4 right-4 text-gray-600 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"><Trash2 size={18}/></button>
                                                <h4 className="font-bold text-white mb-4 pr-10 text-lg leading-snug">"{g.question}"</h4>
                                                <div className="space-y-4">
                                                    {/* Flor Input */}
                                                    <div className={`p-3 rounded-xl border transition-colors ${g.answerFlor ? 'bg-rose-900/20 border-rose-500/30' : 'bg-black/20 border-white/5 border-dashed'}`}>
                                                        <div className="flex justify-between mb-2">
                                                            <span className="text-xs font-bold text-rose-400 flex gap-2 items-center"><Heart size={12}/> Flor</span>
                                                            {g.answerFlor && <Check size={14} className="text-green-400"/>}
                                                        </div>
                                                        {g.answerFlor ? <p className="text-sm text-gray-300 italic">"{g.answerFlor}"</p> : <textarea placeholder="Escribe..." className="w-full text-sm p-2 bg-transparent text-white rounded-lg resize-none outline-none placeholder-gray-600 focus:bg-black/20" onChange={(e)=>setPendingAnswers(p=>({...p, [`${g.id}_flor`]:e.target.value}))} value={pendingAnswers[`${g.id}_flor`]||''}/>}
                                                    </div>
                                                    {/* Tereque Input */}
                                                    <div className={`p-3 rounded-xl border transition-colors ${g.answerTereque ? 'bg-sky-900/20 border-sky-500/30' : 'bg-black/20 border-white/5 border-dashed'}`}>
                                                        <div className="flex justify-between mb-2">
                                                            <span className="text-xs font-bold text-sky-400 flex gap-2 items-center"><User size={12}/> Terequito</span>
                                                            {g.answerTereque && <Check size={14} className="text-green-400"/>}
                                                        </div>
                                                        {g.answerTereque ? <p className="text-sm text-gray-300 italic">"{g.answerTereque}"</p> : <textarea placeholder="Escribe..." className="w-full text-sm p-2 bg-transparent text-white rounded-lg resize-none outline-none placeholder-gray-600 focus:bg-black/20" onChange={(e)=>setPendingAnswers(p=>({...p, [`${g.id}_tereque`]:e.target.value}))} value={pendingAnswers[`${g.id}_tereque`]||''}/>}
                                                    </div>
                                                    {(!g.answerFlor || !g.answerTereque) && <button onClick={()=>handleCompletePendingGame(g)} className="w-full py-3 bg-purple-600 text-white font-bold rounded-xl mt-2 text-sm hover:bg-purple-700 transition-all shadow-lg shadow-purple-900/20">Enviar Respuesta</button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {viewMode === 'wiki' && (
                        <div className="grid md:grid-cols-12 gap-6 fade-in">
                            {/* WIKI FORM */}
                            <div className="md:col-span-4">
                                <div className={`glass-panel p-6 rounded-3xl sticky top-28 border-t-4 ${theme.border}`} style={{backgroundColor: theme.glass}}>
                                    <h2 className={`text-xl font-bold mb-6 flex gap-3 ${theme.text} items-center`}>
                                        {editingId?<Edit2 size={20}/>:<Plus size={20}/>}
                                        {editingId?'Editar Recuerdo':'Nuevo Recuerdo'}
                                    </h2>
                                    <form onSubmit={handleSubmit} className="space-y-5">
                                        <div>
                                            <div className="flex justify-between mb-2"><label className={`text-xs font-bold tracking-wider ${theme.labelColor}`}>CATEGOR√çA</label> {!isAddingCategory && <button type="button" onClick={()=>setIsAddingCategory(true)} className={`text-xs underline ${theme.accent} opacity-70 hover:opacity-100`}>Nueva</button>}</div>
                                            {isAddingCategory ? <div className="flex gap-2"><input autoFocus placeholder="Nombre..." className="flex-1 p-3 rounded-xl bg-black/20 border border-white/10 text-sm text-white" value={newCategoryName} onChange={e=>setNewCategoryName(e.target.value)}/><button type="button" onClick={handleAddCategory} className={`p-3 rounded-xl text-white ${theme.btnBg}`}><Plus size={18}/></button></div> : <select name="category" value={formData.category} onChange={handleInputChange} className="w-full p-3.5 border rounded-xl bg-black/20 border-white/10 text-white focus:border-white/30">{categories.map(c=><option key={c} value={c}>{c}</option>)}</select>}
                                        </div>
                                        <div><label className={`text-xs font-bold tracking-wider mb-2 block ${theme.labelColor}`}>PREGUNTA</label><input name="question" value={formData.question} onChange={handleInputChange} placeholder="Ej: ¬øCu√°l es su postre favorito?" className="w-full p-3.5 border rounded-xl bg-black/20 border-white/10 text-white focus:border-white/30" required /></div>
                                        <div><label className={`text-xs font-bold tracking-wider mb-2 block ${theme.labelColor}`}>RESPUESTA</label><textarea name="answer" value={formData.answer} onChange={handleInputChange} placeholder="Escribe el detalle aqu√≠..." className="w-full p-3.5 border rounded-xl h-32 resize-none bg-black/20 border-white/10 text-white focus:border-white/30 leading-relaxed" required /></div>
                                        <div className="flex gap-3 pt-2">{editingId && <button type="button" onClick={handleCancelEdit} className="px-5 bg-white/5 text-gray-400 rounded-xl font-bold hover:bg-white/10 hover:text-white transition-all border border-white/5">Cancelar</button>}<button type="submit" className={`flex-1 py-3.5 text-white font-bold rounded-xl shadow-lg ${theme.btnBg} transition-all`}>{editingId?'Actualizar':'Guardar en Wiki'}</button></div>
                                    </form>
                                </div>
                            </div>
                            {/* WIKI LIST & ORACLE */}
                            <div className="md:col-span-8 space-y-6">
                                {/* ORACULO CARD - REDISE√ëADA */}
                                <div className={`glass-panel p-8 rounded-3xl shadow-xl relative overflow-hidden border border-white/10 flex flex-col md:flex-row items-center gap-6`}>
                                    <div className="flex-1 w-full">
                                        <h2 className={`text-2xl font-bold mb-3 flex gap-3 ${theme.accent} items-center`}><Sparkles size={24}/> Or√°culo de {activeProfile==='novia'?'Flor':'Terequito'}</h2>
                                        <p className="text-gray-400 text-sm mb-6 leading-relaxed opacity-90">Pregunta lo que quieras. La IA analizar√° toda la base de datos para darte la mejor respuesta.</p>
                                        <form onSubmit={handleAskAI} className="flex gap-3 w-full">
                                            <input value={aiQuery} onChange={e=>setAiQuery(e.target.value)} placeholder={`Ej: ¬øQu√© le puedo regalar a ${activeProfile==='novia'?'Flor':'Terequito'}?`} className="flex-1 p-4 rounded-2xl text-white bg-black/30 border border-white/10 placeholder-gray-500 focus:bg-black/40 transition-all shadow-inner" />
                                            <button type="submit" disabled={isAiThinking} className="bg-white text-gray-900 px-6 rounded-2xl font-bold shadow-lg hover:bg-gray-100 hover:scale-105 transition-all flex items-center justify-center min-w-[60px]">{isAiThinking?<div className="spinner border-gray-900"/>:'Ir'}</button>
                                        </form>
                                        {aiResponse && <div className="mt-6 bg-black/20 p-6 rounded-2xl backdrop-blur-md border border-white/10 text-white text-sm leading-relaxed shadow-inner markdown-body animate-in fade-in zoom-in duration-300" dangerouslySetInnerHTML={{__html: marked.parse(aiResponse)}} />}
                                    </div>
                                    <div className={`hidden md:flex items-center justify-center p-6 rounded-full bg-white/5 border border-white/5 ${theme.glow} animate-pulse`}>
                                        <Sparkles size={80} className={theme.text} strokeWidth={1} />
                                    </div>
                                </div>

                                <div className="flex items-center gap-4 mb-6">
                                     <div className={`p-4 rounded-full glass-panel flex items-center justify-center ${theme.text}`}>
                                        <Search size={24} />
                                    </div>
                                    <input 
                                        type="text" 
                                        placeholder="Buscar en la wiki..." 
                                        value={searchTerm} 
                                        onChange={e=>setSearchTerm(e.target.value)} 
                                        className="flex-1 p-4 px-6 rounded-full glass-panel border border-white/10 outline-none text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-white/10 transition-all shadow-lg"
                                    />
                                </div>

                                <div className="grid gap-4">
                                    {entries.filter(e=>e.target===activeProfile && (e.question.toLowerCase().includes(searchTerm.toLowerCase()) || e.answer.toLowerCase().includes(searchTerm.toLowerCase()) || e.category.toLowerCase().includes(searchTerm.toLowerCase()))).map(e => (
                                        <div key={e.id} className={`glass-panel p-6 rounded-2xl shadow border border-white/5 relative group hover:bg-white/5 transition-colors ${editingId===e.id ? `ring-1 ${theme.accent}` : ''}`}>
                                            <span className={`text-xs font-bold px-3 py-1 rounded-full bg-white/5 border border-white/10 tracking-wide uppercase ${theme.text}`}>{e.category}</span>
                                            <h3 className="font-bold text-lg mt-3 text-white leading-snug">{e.question}</h3>
                                            <p className="text-gray-300 mt-2 whitespace-pre-line leading-relaxed font-light">{e.answer}</p>
                                            <div className="mt-5 flex justify-between items-center pt-4 border-t border-white/5">
                                                <span className="text-xs text-gray-500 font-mono">{e.date}</span>
                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={()=>handleEdit(e)} className={`p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors ${theme.accentHover}`}><Edit2 size={16}/></button><button onClick={()=>handleDelete(e.id)} className="p-2 rounded-lg bg-white/5 hover:bg-red-900/30 hover:text-red-400 text-gray-500 transition-colors"><Trash2 size={16}/></button></div>
                                            </div>
                                        </div>
                                    ))}
                                    {entries.filter(e=>e.target===activeProfile).length === 0 && <div className="text-center py-12 text-gray-600"><p>No hay recuerdos a√∫n.</p></div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>